---
title: "Technical Replication Final Code"
author: "Joe Blaszcynski"
date: "5/13/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Upload data 

```{r, message=FALSE}
library(foreign)
library(MASS)
library(dplyr)
library(haven)
library(tidyverse)
library(arm)
library(car)
library(AER)
library(WDI) # World Data Index; used for GDP data 


dat <- read_dta("data/potter_tavits_data.dta")

#V-Dems version 12 (2022)
vdem <- read_rds("data/V-Dem-CY-Core-v12.rds")


```

# Drop statistical outliers

```{r}

#Liberia 2012 (113), Albania 2003 (1), and Brazil 2003 (31) 

new_data <- dat %>% slice(-c(1,31,113))

```

# Create new subsets for democratic years

```{r}

Post_1974 <- subset(new_data, demin > 1973)

Pre_1974 <- subset(new_data, demin < 1973)

```

# OLS model for all democracies (Left side of table 1 in article (p. 83) 

```{r}

#Model fit for all of the countries 
model_1 <- lm(postenp ~ fundparity4 + demyears + fed + pres + log(avemag) + 
                fract + log(avemag):fract,	data = new_data)

summary(model_1) # signs = 0.1*;0.05**;0.01***

display(model_1)

```

# Table 2: Right side results (p. 83)

```{r}

#Model fit for countries following the year 1974

Model_1974 <- lm(postenp ~ fundparity4 + demyears + fed + pres + log(avemag) + 
                   fract + log(avemag):fract, data = Post_1974)	
summary(Model_1974)

display(Model_1974)

```

# Plot in figure 1 (p. 87)

```{r}

ggplot(new_data, aes(x = preenp, y = fundparity4)) + 
  geom_point() + 
  geom_smooth(se = FALSE, method = lm) + 
  labs(title = "Figure 1", x = "Previous Effective Number of Parties (ENP)", 
       y = "Fund parity")

```

## OLS Assumptions Check - on the orginal models within the study 

\begin{itemize}
  \item{Linear relationship between the predicators (x) and the outcome (y) I} 
  \item{Predictors (x) are indepdent and observed with negligble error II}
  \item{Residual errors have a mean value of zero III}
  \item{Residual errors have constant variance IV}
  \item{Residual errors and indepedent from each other and predictors (x) V}
\end{itemize}


## Resids. vs fitted values (OLS assumption I)


```{r,message=FALSE}

# Model 1: Resids. vs fitted values (OLS assumption I)

par(mfrow = c(2,2))
plot(model_1, which = 1) # Good check line treds on zero 
plot(model_1, which = 2) # Most of the resids are linear; couple of outliers towards the top and bottom 
plot(model_1, which = 3) # Not extreme; but possible hetroskedicity 
plot(model_1, which = 5) # Outliers; 6, 177, and 193 

# Model 1974: Resids. vs fitted values (OLS assumption I) 
#Tests the relationship between fitted and residual values

par(mfrow = c(2,2))
plot(Model_1974, which = 1) # Good linear pattern 
plot(Model_1974, which = 2) # good
plot(Model_1974, which = 3) # Good
plot(Model_1974, which = 4) # good

```


## OLS assumption II - Predictors are independent and observed with negligible error
Both models are greater than 0.05; H0 is failed to reject predictors are independent from the error 

```{r}
durbinWatsonTest(model_1)
durbinWatsonTest(Model_1974)
```

## Assumption III - Linearity present
Both the visual from the first assumption and checking the means 
varifies this assumption that the residuals have a mean value of close to zero

```{r}
# Visual shows 
plot(model_1, which = 1)
# Double check 
mean(model_1$residuals) # close to zero 
mean(Model_1974$residuals) #close to zero 
```

## OLS assumption IV - Residual errors have constant variance 
Plot shows this by the variance of the plotted residuals and the sqrt standarized 
Residuals 

```{r}
plot(Model_1974, which = 3)
# Double check 
ncvTest(Model_1974)
ncvTest(model_1) # p value is greater than 0.05; no heteroskecity 
# p values are both greater than 0.05 
```

# New Anaylsis for final POLS 702 

## Including new variables in orginal data: GDP & V-Dems 

```{r}


tibble(vdem)
range(vdem$year) # filter 2003 & 2012; to match originally collected data 
# variables select - v2psbars; v2x_polyarchy

# barries to parties - v2psbars
# Electoral democracy index - v2x_polyarchy

vdem_1 <- vdem %>% 
   filter(year == 2003 & 2012) %>% 
   dplyr::select(country_name, v2psbars, v2x_polyarchy) %>%  
   mutate(cnty = country_name, 
          partybar = v2psbars, 
          demindy = v2x_polyarchy) %>% 
   dplyr::select(-c("country_name", "v2psbars", "v2x_polyarchy")) %>% 
   na.omit

tibble(vdem_1)

new_final_dat <- left_join(dat, vdem_1, by = "cnty")

tibble(new_final_dat)

summary(new_final_dat$demindy)

# Add GDP
library(WDI) # package in the start of .rmd file 

WDIsearch('gdp.*capita.*constant') # Using the "GDP per capita (constant 2015 US$)"

wdi_dat <- WDI(indicator = 'NY.GDP.PCAP.KD', country = c('all'), start = 2003, 
               end = 2012)

tibble(wdi_dat)

# Combine the GDP data to all of the new data 

WDI_1 <- wdi_dat %>% 
   filter(year == 2003 & 2012) %>% 
   dplyr::select(country, NY.GDP.PCAP.KD) %>%  
   mutate(cnty = country, 
          GDP = NY.GDP.PCAP.KD) %>% 
   dplyr::select(-c("country", "NY.GDP.PCAP.KD")) %>% 
   na.omit

two_dats <- merge(vdem_1, WDI_1, by.x = 'cnty')

tibble(two_dats)

new_final_dat <- left_join(dat, two_dats, by = "cnty")

tibble(new_final_dat)

tibble(new_final_dat$GDP)

summary(new_final_dat$GDP)
```



# Final models & Anaylsis 

```{r}

#Data being used: new_final_dat 

#Raw model to test OLS assumptions 
raw_model <- lm(postenp ~ fundparity4 + demyears + fed + pres + log(avemag)
               + fract + log(avemag):fract + partybar + demindy + log(GDP),
               data = new_final_dat)

plot(raw_model, which = 4) # Outliers = 1, 90, 113 

new_final_dat[ c(1,90,113), ]

newf_dat <- new_final_dat %>% slice(-c(1,90,113))

newf_dat

#First model is all of the countries 

mod_all <- lm(postenp ~ fundparity4 + demyears + fed + pres + log(avemag)
               + fract + log(avemag):fract + partybar + demindy + log(GDP),
               data = newf_dat)
              
summary(mod_all)
display(mod_all)

# Second and third model is based on the polity score 

summary(newf_dat$polity) # Average is rounded 
summary(newf_dat$polity >= 8) #Descriptive stats on polity score in data


############

# Create the subset with the average Polity score 

final_ss <- subset(newf_dat, polity >= 8)

mod_ss_1 <- lm(postenp ~ fundparity4 + demyears + fed + pres + log(avemag)
               + fract + log(avemag):fract + partybar + demindy + log(GDP),
               data = final_ss)

summary(mod_ss_1)
display(mod_ss_1)

```





# OLS Assumptions Check for the Final Models Used 

```{r}

# All the countries assumptions check 

par(mfrow = c(2,2))
plot(mod_all, which = 1)
plot(mod_all, which = 2)
plot(mod_all, which = 3)
plot(mod_all, which = 4)

durbinWatsonTest(mod_all) #Greater than 0.05 


plot(mod_all, which = 1)
# Double check 
mean(mod_all$residuals) # # Confirmed that there is no hertroskectiy present


plot(mod_all, which = 3)
ncvTest(mod_all)

vif(mod_all, type = c("marginal")) # Levels of 4 and 10; warrant further
                                    # investigation. 
                                    # Warning levels not present in model.


# Polity model assumptions check 

par(mfrow = c(2,2))
plot(mod_ss_1, which = 1)
plot(mod_ss_1, which = 2)
plot(mod_ss_1, which = 3)
plot(mod_ss_1, which = 4)


durbinWatsonTest(Model_1974) #Greater than 0.05 

plot(model_1, which = 1)
# Double check 
mean(model_1$residuals) # close to zero 


plot(model_1, which = 3)
ncvTest(model_1) # Confirmed that there is no hertroskectiy present 


vif(mod_ss_1, type = c("marginal")) # Levels of 4 and 10; warrent further
                                    #investigation. 
                                    #Warning levels not present in model. 

```

# Conclusion(rough)

Overall, the replicated findings do not deviate from the original findings. 
The goal of conducting this replication analysis was to further understand if
additional explanatory variables in the regression analysis would improve the findings. 
This was not necessarily the case however, both of the replicated final models 
had a increase the R^2 term making the model more effective than the original models. 
Despite this finding, only the main interaction of the unique independent variable
the authors create remains significant across the board. 






